## 多任务-1

### 序
这一章我们来讲解多任务，作者本书中的多任务也是只是在一个cpu上实现。大家接触操作系统中可以将任务的概念理解成进程，不过linux或者windows的进程要比这里说的任务复杂很多。<br>
那么多任务就是指cpu上可以运行多个任务，多个任务之间的来回切换，达到给人多个程序并行的感觉。


### 知识储备
cpu原生支持多任务，是通过TSS来支持，我们下边要来学习一下关于TSS和LDT

#### TSS（Task State Segment）
TSS即任务状态段，一个CPU执行多个任务的时候，就需要将任务之间来回切换。当CPU执行任务时，会将任务所需要的数据加载到寄存器，栈和内存，而任务执行的最新状态在寄存器中体现，那么当任务切换走的时候需要将寄存器中的数据保存，以便当切换回来时任务能够继续之前的位置执行。那么如何做到呢，就是给每一个任务配备一个TSS，用它来保存任务的寄存器等数据，或者说是任务的上下文。<br>
TSS是cpu已经规定好了，不过需要操作系统来将提给内存位置，之后由cpu来维护。这里维护就是指切换时会自动将数据等保存在TSS内存位置，新的任务的TSS值载入到寄存器中。<br>
先来看下TSS的结构：<br>
<img src="https://user-images.githubusercontent.com/22785392/173829425-02424dfd-8c48-4b4c-a8b4-fecec18e6108.png" width="50%" height="50%" />

我们看到保存的数据大多数都是寄存器的值，要注意有几个地方：
* 有三个ss和ESP，这主要和特权级有关，不同的特权使用不同栈地址。<br>
特权级有4级，操作系统是0特权级，应用程序就是3特权级。由低特权级跳转到高特权级时会用到这三组寄存器，但是由高特权级到低特权级弹出栈就可以，无需要TSS，所以只有3组而不是4组。
* 然后“Previous Task Link”保存上一个任务的TSS的地址，这里主要用于嵌套的任务切换，也就是一个任务嵌套去调用另外一个任务时会用到，作者使用的时非嵌套的任务切换，这里就先不提了。
* 还有一个地方要说明的是，TSS中会保存“LDT Segament Selector”，就是LDT的段选择子，关于LDT我们后边再说。
* I/Omap 这里用于程序执行IO操作针对每个IO端口的权限设置，这里我们也不会用到。
<br><br>

有了这个结构我们知道，这个结构是CPU规定的，也就是说CPU只会这么访问。但是这块数据是需要操作系统来提供。也就是我们需要保存这个数据结构在内存中。
那么CPU怎么去访问呢，哈，还是通过段描述符去访问，TSS的段描述符我们可以放到GDT中，也可以放到IDT中，不过放到IDT中是另外一种实现任务切换的方式（通过中断来实现任务切换）。我们这里并不是使用这个方式来任务切换，我们需要把TSS段描述符放到GDT中。那么cpu如何定位到TSS段描述符，那就是借助TR（Task Register）这个寄存器来定位了。TR寄存器中存放的是TSS段描述符的选择子，看下整体的结构：<br>
<img src="https://user-images.githubusercontent.com/22785392/173829667-ec6af086-b08b-4c6f-9fa8-a3477e730f6b.png" width="80%" height="80%" />
<br>
先看下TSS的段描述符，和一些GDT的描述符几乎没什么区别，不过TSS属于系统段，所以S位为0，type为1001表示是TSS段。然后基址存放的就是TSS的内存地址，limit就是TSS的大小，我们这里limit都是设置为103字节。<br>
我们定位到TSS的段描述符还需要TR寄存器指向，那么TR寄存器中存放的就是TSS段描述符的选择子，我们看下TR的大致结构：<br>
<img src="https://user-images.githubusercontent.com/22785392/173829837-6970340d-3421-4292-85ee-06e0f3a14c66.png" width="60%" height="60%" />
由选择器和描述符缓冲器组成，16位的段选择子可以找到TSS的段描述符，描述符缓冲器用来保存描述符的基础地址和界限，这样cpu执行时可以通过TR寄存器直接定位到TSS的地址。我们使用'ltr'汇编命令来将装载TR寄存器（后边代码中会看到）。<br>
也就是说初始化操作系统时需要使用'ltr'汇编命令将当前TSS段载入到寄存器，方便后边的任务切换。


#### LDT（Local Descriptor Table）


### 任务切换方式
jmp/call，TR切换，导致IP寻址，进而任务切换
